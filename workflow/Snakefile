configfile: "config/config.yaml"

include: "rules/list_scans.smk"

MAPPING = list_scans(config["datadir"], config["ethics_prefix"])
SUBJECTS, SESSIONS = zip(*MAPPING)

rule all:
    localrule: True
    default_target: True
    input:
        expand(
            expand(
                "{{resultsdir}}/bids/derivatives/dwi_preprocessing/sub-{subject}/ses-{session}",
                zip,
                subject=SUBJECTS,
                session=SESSIONS,
            ),
            resultsdir=config["resultsdir"],
        )

module bids_conversion:
    snakefile:
        "rules/bids_conversion.smk"
    config: config

use rule * from bids_conversion as bids_conversion_*

module dwi_preprocessing:
    snakefile:
        "rules/dwi_preprocessing.smk"
    config: config

use rule * from dwi_preprocessing as dwi_preprocessing_*

def get_derivatives_filenames(wildcards):
    # create a dependency on heudiconv rule output
    checkpoints.heudiconv.get(**wildcards)

    bids_pattern = (
        f"{wildcards.resultsdir}/bids/sub-{wildcards.subject}/ses-{wildcards.session}"
        f"/anat/sub-{wildcards.subject}_ses-{wildcards.session}_"
        "{entity}_T1w.nii.gz"
    )
    entities, = glob_wildcards(bids_pattern)

    basedir = "{resultsdir}/bids/derivatives/dwi_preprocessing/derivatives"
    filenames_pattern = [
        "/misc/sub-{subject}/ses-{session}/dwi/sub-{subject}_ses-{session}_{entity}_dwi_brain_mask.nii.gz",
        "/hd_bet/sub-{subject}/ses-{session}/anat/sub-{subject}_ses-{session}_{entity}_T1w_brain.nii.gz",
        "/eddy/sub-{subject}/ses-{session}/dwi/sub-{subject}_ses-{session}_{entity}_eddy.nii.gz",
        "/eddy/sub-{subject}/ses-{session}/dwi/sub-{subject}_ses-{session}_{entity}_eddy.eddy_rotated_bvecs"
    ]
    filenames_pattern = [basedir + pattern for pattern in filenames_pattern]

    filenames = expand(filenames_pattern, entity=entities, **wildcards)

    return filenames

rule dwi_preprocessing:
    localrule: True
    input:
        get_derivatives_filenames
    output:
        directory("{resultsdir}/bids/derivatives/dwi_preprocessing/sub-{subject}/ses-{session}")
    shell:
        # TODO copy or move instead of linking?
        # TODO use subdirectories (anat and dwi)
        "mkdir -p {output} && ln -s {input} {output}"
